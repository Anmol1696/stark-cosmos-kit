{"version":3,"sources":["../../src/extension/signer.ts"],"sourcesContent":["import { wasmTypes } from '@cosmjs/cosmwasm-stargate/build/modules';\nimport {\n  AccountData,\n  DirectSecp256k1Wallet,\n  DirectSignResponse,\n  OfflineDirectSigner,\n} from '@cosmjs/proto-signing';\nimport { Registry } from '@cosmjs/proto-signing/build/registry';\nimport { defaultRegistryTypes } from '@cosmjs/stargate';\nimport { SignDoc, TxBody } from 'cosmjs-types/cosmos/tx/v1beta1/tx';\n\nimport { Web3AuthClient } from './client';\n\nconst registry = new Registry([...defaultRegistryTypes, ...wasmTypes]);\n\nexport class Web3AuthCustomSigner implements OfflineDirectSigner {\n  client: Web3AuthClient;\n  chainId: string;\n\n  constructor(client: Web3AuthClient, chainId: string) {\n    this.client = client;\n    this.chainId = chainId;\n  }\n\n  async getSigner(chainId: string): Promise<DirectSecp256k1Wallet> {\n    if (!this.client.signers[chainId]) {\n      await this.client.connect(chainId);\n    }\n\n    return this.client.signers[chainId];\n  }\n\n  async getAccounts(): Promise<readonly AccountData[]> {\n    return (await this.getSigner(this.chainId)).getAccounts();\n  }\n\n  async signDirect(\n    signerAddress: string,\n    signDoc: SignDoc\n  ): Promise<DirectSignResponse> {\n    if (signDoc.chainId !== this.chainId) {\n      throw new Error('Chain ID mismatch');\n    }\n\n    const signer = await this.getSigner(signDoc.chainId);\n\n    // TODO: Improve prompt UI.\n    const decodedMessages = TxBody.decode(signDoc.bodyBytes).messages.map(\n      (message) => ({\n        '@type': message.typeUrl,\n        ...registry.decode(message),\n      })\n    );\n\n    return new Promise((resolve, reject) => {\n      // Add modal to body.\n      const modal = document.createElement('div');\n      modal.id = 'web3auth-modal';\n      modal.style.position = 'fixed';\n      modal.style.top = '0';\n      modal.style.left = '0';\n      modal.style.width = '100%';\n      modal.style.height = '100%';\n      modal.style.zIndex = '999999';\n      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\n      modal.style.display = 'flex';\n      modal.style.justifyContent = 'center';\n      modal.style.alignItems = 'center';\n      document.body.appendChild(modal);\n\n      // Add modal content.\n      const modalContent = document.createElement('div');\n      modalContent.style.backgroundColor = '#fff';\n      modalContent.style.padding = '1rem';\n      modalContent.style.borderRadius = '0.5rem';\n      modalContent.style.maxWidth = '50rem';\n      modalContent.style.width = '100%';\n      modalContent.style.maxHeight = '50rem';\n      modalContent.style.overflow = 'auto';\n      modal.appendChild(modalContent);\n\n      // Add modal title.\n      const modalTitle = document.createElement('h2');\n      modalTitle.innerText = 'Web3Auth';\n      modalTitle.style.margin = '0';\n      modalTitle.style.padding = '0';\n      modalTitle.style.fontSize = '1.5rem';\n      modalTitle.style.fontWeight = 'bold';\n      modalContent.appendChild(modalTitle);\n\n      // Add modal description.\n      const modalDescription = document.createElement('p');\n      modalDescription.innerText = 'Sign transaction?';\n      modalDescription.style.margin = '0';\n      modalDescription.style.padding = '0';\n      modalDescription.style.fontSize = '1rem';\n      modalDescription.style.fontWeight = 'normal';\n      modalContent.appendChild(modalDescription);\n\n      // Add modal JSON.\n      const modalJson = document.createElement('pre');\n      modalJson.innerText = JSON.stringify(decodedMessages, null, 2);\n      modalJson.style.margin = '0';\n      modalJson.style.padding = '0';\n      modalJson.style.fontSize = '1rem';\n      modalJson.style.fontWeight = 'normal';\n      modalContent.appendChild(modalJson);\n\n      // Add modal buttons.\n      const modalButtons = document.createElement('div');\n      modalButtons.style.margin = '0';\n      modalButtons.style.padding = '0';\n      modalButtons.style.display = 'flex';\n      modalButtons.style.justifyContent = 'flex-end';\n      modalContent.appendChild(modalButtons);\n\n      // Add modal cancel button.\n      const modalCancelButton = document.createElement('button');\n      modalCancelButton.innerText = 'Cancel';\n      modalCancelButton.style.margin = '0';\n      modalCancelButton.style.padding = '0.5rem 1rem';\n      modalCancelButton.style.fontSize = '1rem';\n      modalCancelButton.style.fontWeight = 'bold';\n      modalCancelButton.style.backgroundColor = '#fff';\n      modalCancelButton.style.border = '1px solid #000';\n      modalCancelButton.style.borderRadius = '0.25rem';\n      modalCancelButton.style.cursor = 'pointer';\n      modalCancelButton.onclick = () => {\n        const modal = document.getElementById('web3auth-modal');\n        if (modal) {\n          modal.remove();\n        }\n        reject(new Error('Request rejected'));\n      };\n      modalButtons.appendChild(modalCancelButton);\n\n      // Add modal confirm button.\n      const modalConfirmButton = document.createElement('button');\n      modalConfirmButton.innerText = 'Confirm';\n      modalConfirmButton.style.margin = '0 0 0 0.5rem';\n      modalConfirmButton.style.padding = '0.5rem 1rem';\n      modalConfirmButton.style.fontSize = '1rem';\n      modalConfirmButton.style.fontWeight = 'bold';\n      modalConfirmButton.style.backgroundColor = '#000';\n      modalConfirmButton.style.color = '#fff';\n      modalConfirmButton.style.border = '1px solid #000';\n      modalConfirmButton.style.borderRadius = '0.25rem';\n      modalConfirmButton.style.cursor = 'pointer';\n      modalConfirmButton.onclick = () => {\n        const modal = document.getElementById('web3auth-modal');\n        if (modal) {\n          modal.remove();\n        }\n        signer.signDirect(signerAddress, signDoc).then(resolve).catch(reject);\n      };\n      modalButtons.appendChild(modalConfirmButton);\n    });\n  }\n}\n"],"mappings":"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","names":["modal"]}